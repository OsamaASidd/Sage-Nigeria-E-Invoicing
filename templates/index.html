<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Invoicing | Proton Security Services</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --navy: #0f172a; --blue: #2563eb; --blue-light: #3b82f6; --blue-bg: #eff6ff;
            --green: #16a34a; --green-bg: #f0fdf4; --green-border: #bbf7d0;
            --red: #dc2626; --red-bg: #fef2f2; --red-border: #fecaca;
            --amber: #d97706; --amber-bg: #fffbeb; --amber-border: #fde68a;
            --slate50: #f8fafc; --slate100: #f1f5f9; --slate200: #e2e8f0;
            --slate300: #cbd5e1; --slate400: #94a3b8; --slate500: #64748b;
            --slate600: #475569; --slate700: #334155; --slate800: #1e293b;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08);
        }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--slate50); color: var(--slate800); min-height: 100vh; }

        .header { background: var(--navy); color: white; padding: 0 32px; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 14px; }
        .header-logo { width: 36px; height: 36px; background: var(--blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .header-title { font-size: 16px; font-weight: 600; }
        .header-subtitle { font-size: 12px; color: var(--slate400); }
        .header-env { font-family: 'JetBrains Mono', monospace; font-size: 11px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; color: var(--amber); }

        .sync-banner { background: var(--blue-bg); border-bottom: 1px solid #bfdbfe; color: var(--blue); padding: 10px 32px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .sync-banner.success { background: var(--green-bg); border-color: var(--green-border); color: var(--green); }
        .sync-banner.error { background: var(--red-bg); border-color: var(--red-border); color: var(--red); }
        .spinner-sm { width: 14px; height: 14px; border: 2px solid #bfdbfe; border-top-color: var(--blue); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }

        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 24px 32px; max-width: 1400px; margin: 0 auto; }
        .stat-card { background: white; border-radius: var(--radius); padding: 20px 24px; border: 1px solid var(--slate200); box-shadow: var(--shadow); }
        .stat-label { font-size: 12px; font-weight: 500; color: var(--slate500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; color: var(--slate800); }
        .stat-card.posted .stat-value { color: var(--green); }
        .stat-card.pending .stat-value { color: var(--amber); }
        .stat-card.failed .stat-value { color: var(--red); }

        .toolbar { display: flex; align-items: center; justify-content: space-between; padding: 0 32px 16px; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; gap: 10px; }
        .toolbar-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .toolbar-right { display: flex; align-items: center; gap: 10px; }
        .search-box { position: relative; }
        .search-box input { font-family: 'DM Sans', sans-serif; padding: 8px 14px 8px 36px; border: 1px solid var(--slate300); border-radius: 6px; font-size: 13px; width: 220px; outline: none; background: white; }
        .search-box input:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .search-box svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--slate400); }
        .date-range { display: flex; align-items: center; gap: 6px; }
        .date-range label { font-size: 12px; font-weight: 500; color: var(--slate500); }
        .date-range input[type="date"] { font-family: 'DM Sans', sans-serif; padding: 7px 10px; border: 1px solid var(--slate300); border-radius: 6px; font-size: 12px; background: white; outline: none; color: var(--slate700); }
        .date-range input[type="date"]:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .btn { font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; white-space: nowrap; text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--blue-light); }
        .btn-outline { background: white; color: var(--slate700); border: 1px solid var(--slate300); }
        .btn-outline:hover:not(:disabled) { background: var(--slate50); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-sm { font-size: 12px; padding: 5px 10px; }

        .table-wrap { padding: 0 32px 16px; max-width: 1400px; margin: 0 auto; }
        .table-container { background: white; border-radius: var(--radius); border: 1px solid var(--slate200); box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--slate50); border-bottom: 1px solid var(--slate200); }
        th { text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--slate500); padding: 12px 14px; white-space: nowrap; }
        td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid var(--slate100); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--slate50); }
        .col-mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 500; }
        .col-amount { font-family: 'JetBrains Mono', monospace; font-size: 12px; text-align: right; font-weight: 600; }
        .col-customer { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
        .col-custid { font-size: 12px; color: var(--slate600); }
        .col-date { font-size: 12px; color: var(--slate600); white-space: nowrap; }

        .badge { font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 20px; display: inline-block; }
        .badge-posted { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
        .badge-pending { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
        .badge-failed { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }

        .actions-cell { white-space: nowrap; text-align: center; }
        .actions-cell .btn { min-width: 80px; justify-content: center; }

        /* Pagination */
        .pagination { display: flex; align-items: center; justify-content: space-between; padding: 0 32px 32px; max-width: 1400px; margin: 0 auto; }
        .page-info { font-size: 13px; color: var(--slate500); }
        .page-buttons { display: flex; gap: 4px; }
        .page-btn { font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; padding: 6px 12px; border: 1px solid var(--slate300); border-radius: 6px; background: white; cursor: pointer; color: var(--slate700); text-decoration: none; }
        .page-btn:hover { background: var(--slate50); }
        .page-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        .page-btn.disabled { opacity: 0.4; pointer-events: none; }

        .toast-container { position: fixed; top: 76px; right: 24px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: white; border: 1px solid var(--slate200); border-radius: 8px; padding: 12px 20px; font-size: 13px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; min-width: 300px; }
        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        .toast.info { border-left: 3px solid var(--blue); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        .spinner-dark { border-color: rgba(0,0,0,0.1); border-top-color: var(--slate600); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--slate500); }
        .empty-state h3 { font-size: 16px; color: var(--slate700); margin-bottom: 6px; }
        .empty-state p { font-size: 13px; margin-bottom: 20px; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 12px; padding: 28px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal h3 { font-size: 16px; margin-bottom: 8px; }
        .modal p { font-size: 13px; color: var(--slate600); margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }

        @media (max-width: 900px) {
            .stats-bar { grid-template-columns: repeat(2, 1fr); padding: 16px; }
            .toolbar, .table-wrap, .pagination { padding-left: 16px; padding-right: 16px; }
            .header { padding: 0 16px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-left">
            <div class="header-logo">PS</div>
            <div>
                <div class="header-title">E-Invoicing Dashboard</div>
                <div class="header-subtitle">Proton Security Services Ltd</div>
            </div>
        </div>
        <span class="header-env">PREPROD</span>
    </header>

    <!-- Auto-sync banner -->
    <div class="sync-banner" id="syncBanner" style="display:none">
        <span class="spinner-sm" id="syncSpinner"></span>
        <span id="syncBannerText">Syncing invoices from Sage 50...</span>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Total Invoices</div>
            <div class="stat-value" id="statTotal">{{ stats.total }}</div>
        </div>
        <div class="stat-card posted">
            <div class="stat-label">Posted to FIRS</div>
            <div class="stat-value" id="statPosted">{{ stats.posted }}</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-label">Pending</div>
            <div class="stat-value" id="statPending">{{ stats.pending }}</div>
        </div>
        <div class="stat-card failed">
            <div class="stat-label">Failed</div>
            <div class="stat-value" id="statFailed">{{ stats.failed }}</div>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-left">
            <div class="date-range">
                <label>From</label>
                <input type="date" id="dateFrom" value="">
                <label>To</label>
                <input type="date" id="dateTo" value="">
            </div>
            <div class="search-box">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="Search invoices..." oninput="filterTable()">
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-outline" onclick="syncSage()" id="btnSync">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                Sync Date Range
            </button>
            <button class="btn btn-primary" onclick="postAllPending()" id="btnPostAll">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                Post All Pending
            </button>
        </div>
    </div>

    <div class="table-wrap">
        <div class="table-container">
            {% if invoices %}
            <table id="invoiceTable">
                <thead>
                    <tr>
                        <th>Customer Name</th>
                        <th>Customer ID</th>
                        <th>Invoice No.</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th style="text-align:right">Invoice Total</th>
                        <th style="text-align:center">Post to FIRS</th>
                        <th style="text-align:center">Download PDF</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in invoices %}
                    <tr data-trx="{{ inv.trx_number }}" data-status="{{ inv.status }}"
                        data-search="{{ inv.invoice_num|lower }} {{ inv.customer_name|lower }} {{ inv.customer_id|lower }}">
                        <td class="col-customer" title="{{ inv.customer_name }}">{{ inv.customer_name }}</td>
                        <td class="col-custid">{{ inv.customer_id or '—' }}</td>
                        <td class="col-mono">{{ inv.invoice_num or ('TRX-' ~ inv.trx_number) }}</td>
                        <td class="col-date">{{ inv.invoice_date }}</td>
                        <td>
                            <span class="badge badge-{{ inv.status }}"
                                  {% if inv.status == 'failed' and inv.error_message %}
                                  title="{{ inv.error_message }}"
                                  style="cursor:help"
                                  {% endif %}>
                                {{ inv.status|upper }}
                            </span>
                            {% if inv.status == 'failed' and inv.error_message %}
                            <div style="font-size:10px;color:var(--red);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px" title="{{ inv.error_message }}">
                                {{ inv.error_message[:60] }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="col-amount">{{ "{:,.2f}".format(inv.amount|abs) }}</td>
                        <td class="actions-cell">
                            {% if inv.status == 'posted' %}
                                <span style="color:var(--green);font-size:12px;font-weight:600">&#10003; Done</span>
                            {% elif inv.status == 'failed' %}
                                <button class="btn btn-sm" style="background:var(--red);color:white" onclick="postInvoice({{ inv.trx_number }}, this)">Retry</button>
                            {% else %}
                                <button class="btn btn-primary btn-sm" onclick="postInvoice({{ inv.trx_number }}, this)">Post</button>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            {% if inv.status == 'posted' %}
                                <a href="/download/{{ inv.trx_number }}" class="btn btn-success btn-sm">PDF &darr;</a>
                            {% else %}
                                <span style="color:var(--slate400);font-size:12px">&mdash;</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--slate300)" stroke-width="1.5" style="margin-bottom:16px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <h3>No invoices yet</h3>
                <p>Click "Refresh from Sage" to sync, or wait for auto-sync to complete.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <div class="page-info">
            Showing page {{ page }} of {{ total_pages }} ({{ total }} invoices)
        </div>
        <div class="page-buttons">
            <a href="/?page={{ page - 1 }}" class="page-btn {{ 'disabled' if page <= 1 }}">&laquo; Prev</a>
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="page-btn active">{{ p }}</span>
                {% elif p <= 3 or p >= total_pages - 1 or (p >= page - 1 and p <= page + 1) %}
                    <a href="/?page={{ p }}" class="page-btn">{{ p }}</a>
                {% elif p == 4 and page > 5 %}
                    <span class="page-btn disabled">&hellip;</span>
                {% elif p == total_pages - 2 and page < total_pages - 4 %}
                    <span class="page-btn disabled">&hellip;</span>
                {% endif %}
            {% endfor %}
            <a href="/?page={{ page + 1 }}" class="page-btn {{ 'disabled' if page >= total_pages }}">Next &raquo;</a>
        </div>
    </div>
    {% endif %}

    <div class="toast-container" id="toasts"></div>

    <div class="modal-overlay" id="bulkModal">
        <div class="modal">
            <h3>Post All Pending Invoices?</h3>
            <p id="bulkModalText">This will submit all pending invoices to FIRS.</p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeBulkModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmPostAll()">Yes, Post All</button>
            </div>
        </div>
    </div>

<script>
function toast(message, type='info') {
    const c = document.getElementById('toasts');
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    const icons = {
        success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
        info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
    };
    el.innerHTML = (icons[type]||icons.info) + '<span>' + message + '</span>';
    c.appendChild(el);
    setTimeout(function() { el.style.opacity='0'; setTimeout(function(){el.remove()}, 300); }, 4000);
}

/* ---- Set default date range to current month ---- */
var _syncInterval = null;

window.addEventListener('DOMContentLoaded', function() {
    var now = new Date();
    var y = now.getFullYear();
    var m = String(now.getMonth() + 1).padStart(2, '0');
    var lastDay = new Date(y, now.getMonth() + 1, 0).getDate();
    document.getElementById('dateFrom').value = y + '-' + m + '-01';
    document.getElementById('dateTo').value = y + '-' + m + '-' + String(lastDay).padStart(2, '0');

    // Initial sync on page load
    autoSync(true);

    // Auto-resync every 5 minutes (300000ms)
    _syncInterval = setInterval(function() {
        autoSync(false);
    }, 300000);
});

function getDateRange() {
    return {
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value,
    };
}

function autoSync(isInitial) {
    var banner = document.getElementById('syncBanner');
    var txt = document.getElementById('syncBannerText');
    var sp = document.getElementById('syncSpinner');
    var dr = getDateRange();
    banner.style.display = 'flex';
    banner.className = 'sync-banner';
    txt.textContent = 'Syncing invoices from Sage 50 (' + dr.date_from + ' to ' + dr.date_to + ')...';
    sp.style.display = '';

    fetch('/api/sync', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dr)
    })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            sp.style.display = 'none';
            if (data.ok) {
                banner.className = 'sync-banner success';
                txt.textContent = 'Synced ' + data.synced + ' invoices' +
                    (data.new > 0 ? ' (' + data.new + ' new)' : '') +
                    ' for ' + data.date_from + ' to ' + data.date_to +
                    ' — Next auto-sync in 5 min';
                // Only reload if there are NEW invoices (not on every sync)
                if (data.new > 0) {
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    setTimeout(function() { banner.style.display = 'none'; }, 4000);
                }
            } else {
                banner.className = 'sync-banner error';
                txt.textContent = 'Sage sync failed: ' + (data.error || 'Unknown error');
            }
        })
        .catch(function(e) {
            sp.style.display = 'none';
            banner.className = 'sync-banner error';
            txt.textContent = 'Sync error: ' + e.message;
        });
}

function syncSage() {
    var btn = document.getElementById('btnSync');
    var dr = getDateRange();
    if (!dr.date_from || !dr.date_to) {
        toast('Please select both From and To dates', 'error');
        return;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner spinner-dark"></span> Syncing...';
    fetch('/api/sync', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dr)
    })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                toast('Synced ' + data.synced + ' invoices (' + data.new + ' new) for ' + data.date_from + ' to ' + data.date_to, 'success');
                if (data.new > 0) {
                    setTimeout(function() { location.reload(); }, 800);
                } else {
                    resetSyncBtn();
                    // Reload anyway on manual sync to show updated data
                    setTimeout(function() { location.reload(); }, 800);
                }
            } else {
                toast('Sync failed: ' + data.error, 'error');
                resetSyncBtn();
            }
        })
        .catch(function(e) {
            toast('Sync error: ' + e.message, 'error');
            resetSyncBtn();
        });
}

function resetSyncBtn() {
    var btn = document.getElementById('btnSync');
    btn.disabled = false;
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Sync Date Range';
}

function postInvoice(trx, btnEl) {
    btnEl.disabled = true;
    btnEl.innerHTML = '<span class="spinner"></span>';
    fetch('/api/post/' + trx, { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                toast('Posted! IRN: ' + data.irn, 'success');
                setTimeout(function() { location.reload(); }, 800);
            } else {
                var errMsg = data.error || 'Unknown error';
                toast('Failed: ' + errMsg, 'error');
                btnEl.disabled = false;
                btnEl.innerHTML = 'Retry';
                btnEl.title = errMsg;
                console.error('Post TRX ' + trx + ' failed:', errMsg);
            }
        })
        .catch(function(e) {
            toast('Error: ' + e.message, 'error');
            btnEl.disabled = false;
            btnEl.innerHTML = 'Retry';
            console.error('Post TRX ' + trx + ' exception:', e);
        });
}

function postAllPending() {
    var pending = document.querySelectorAll('tr[data-status="pending"]').length;
    if (pending === 0) { toast('No pending invoices on this page', 'info'); return; }
    document.getElementById('bulkModalText').textContent =
        'This will submit ALL pending invoices to FIRS. Continue?';
    document.getElementById('bulkModal').classList.add('active');
}
function closeBulkModal() { document.getElementById('bulkModal').classList.remove('active'); }
function confirmPostAll() {
    closeBulkModal();
    var btn = document.getElementById('btnPostAll');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Posting...';
    fetch('/api/post-bulk', { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) {
                toast('Done! ' + data.posted + ' posted, ' + data.failed + ' failed',
                      data.failed > 0 ? 'error' : 'success');
                setTimeout(function() { location.reload(); }, 1000);
            } else { toast('Bulk post failed', 'error'); }
            resetPostAllBtn();
        })
        .catch(function(e) {
            toast('Error: ' + e.message, 'error');
            resetPostAllBtn();
        });
}
function resetPostAllBtn() {
    var btn = document.getElementById('btnPostAll');
    btn.disabled = false;
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Post All Pending';
}

function filterTable() {
    var query = document.getElementById('searchInput').value.toLowerCase();
    var rows = document.querySelectorAll('#invoiceTable tbody tr');
    rows.forEach(function(row) {
        row.style.display = (!query || row.dataset.search.indexOf(query) !== -1) ? '' : 'none';
    });
}
</script>
</body>
</html>